const a6_0x48a6=['NX_AGENT_NAME','completedTasks','execSync','./distributed-agent.api','Agent\x20was\x20terminated\x20via\x20SIGINT','projectName','defineProperty','mkdirSync','./node_modules/.cache/nx','SIGTERM','env','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','then','../../../utilities/waiter','toString','wait','find','NO_FURTHER_TASKS_TO_RUN','strip-json-comments','CIRCLE_JOB','getTime','retryDuring:\x20','VERBOSE_LOGGING','completeRunGroupWithError','completed:\x20','join','Distributed\x20Execution\x20Terminated','params','forEach','.lock','configuration','createUnchangedValueTimeout','Waiting...','Agent\x20was\x20terminated\x20via\x20SIGTERM','tasks','error:\x20','\x20seconds','\x20--parallel\x20--max-parallel=','/lockfiles','throw','../../../utilities/environment','message','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','maxParallel','includes','startAgent','retryDuring','exit','executionId','floor','RUN_GROUP_COMPLETED','NO_MESSAGES_TIMEOUT','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','reset','CIRCLE_STAGE','../../../utilities/create-unchanged-value-timeout','status','target','done','push','readFileSync','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','projects','Other\x20Nx\x20Cloud\x20Agents\x20Detected','/nx.json','CIRCLECI','../../../utilities/metric-logger','writeFileSync','next','../../error/print-run-group-error','SIGINT','error','completed','note','length','catch','submitRunMetrics','Executing:\x20\x27','number\x20of\x20tasks:\x20','inherit','parse','Fetching\x20tasks...','cacheDirectory','existsSync','unlinkSync','--configuration=','Waiter','../../../utilities/nx-imports','completedStatusCode','API\x20Response','criticalErrorMessage','printRunGroupError','default'];(function(_0x1fe380,_0x48a695){const _0x4cad34=function(_0x4f2723){while(--_0x4f2723){_0x1fe380['push'](_0x1fe380['shift']());}};_0x4cad34(++_0x48a695);}(a6_0x48a6,0xea));const a6_0x4cad=function(_0x1fe380,_0x48a695){_0x1fe380=_0x1fe380-0x0;let _0x4cad34=a6_0x48a6[_0x1fe380];return _0x4cad34;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x45a2a9,_0x5950a3,_0x26b672,_0x59cdea){function _0x2b625e(_0x14c15d){return _0x14c15d instanceof _0x26b672?_0x14c15d:new _0x26b672(function(_0x28e996){_0x28e996(_0x14c15d);});}return new(_0x26b672||(_0x26b672=Promise))(function(_0x43d310,_0x39727a){function _0x43b794(_0xdf86ab){try{_0x3637db(_0x59cdea[a6_0x4cad('0x14')](_0xdf86ab));}catch(_0x2c0170){_0x39727a(_0x2c0170);}}function _0x68652a(_0x50afd4){try{_0x3637db(_0x59cdea[a6_0x4cad('0x54')](_0x50afd4));}catch(_0x43f859){_0x39727a(_0x43f859);}}function _0x3637db(_0x21293d){_0x21293d[a6_0x4cad('0xa')]?_0x43d310(_0x21293d['value']):_0x2b625e(_0x21293d['value'])[a6_0x4cad('0x39')](_0x43b794,_0x68652a);}_0x3637db((_0x59cdea=_0x59cdea['apply'](_0x45a2a9,_0x5950a3||[]))[a6_0x4cad('0x14')]());});};Object[a6_0x4cad('0x33')](exports,'__esModule',{'value':!![]});exports[a6_0x4cad('0x5a')]=void 0x0;const child_process_1=require('child_process');const fs_1=require('fs');const stripJsonComments=require(a6_0x4cad('0x3f'));const create_unchanged_value_timeout_1=require(a6_0x4cad('0x7'));const environment_1=require(a6_0x4cad('0x55'));const metric_logger_1=require(a6_0x4cad('0x12'));const waiter_1=require(a6_0x4cad('0x3a'));const print_run_group_error_1=require(a6_0x4cad('0x15'));const distributed_agent_api_1=require(a6_0x4cad('0x30'));const {output,workspaceRoot}=require(a6_0x4cad('0x27'));function executeTasks(_0x5ba313,_0x26aa10){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x1818ad=0x0;let _0x165c6d=null;const _0x37e3da=(0x0,create_unchanged_value_timeout_1[a6_0x4cad('0x4c')])({'title':'No\x20new\x20messages\x20received\x20after\x20'+environment_1['NO_MESSAGES_TIMEOUT']/0x3e8+a6_0x4cad('0x51'),'timeout':environment_1[a6_0x4cad('0x3')]});const _0x4f75fd=new waiter_1[(a6_0x4cad('0x26'))]();let _0x3d24d3=[];const _0x490299=new Date();let _0x14bd76=![];while(!![]){if(environment_1['VERBOSE_LOGGING']){output[a6_0x4cad('0x19')]({'title':a6_0x4cad('0x21')});}_0x165c6d=yield _0x26aa10['tasks'](_0x165c6d?_0x165c6d[a6_0x4cad('0x0')]:null,_0x1818ad,_0x3d24d3);if(environment_1[a6_0x4cad('0x43')]){output[a6_0x4cad('0x19')]({'title':a6_0x4cad('0x29'),'bodyLines':[a6_0x4cad('0x45')+_0x165c6d[a6_0x4cad('0x18')],'status:\x20'+_0x165c6d[a6_0x4cad('0x8')],a6_0x4cad('0x42')+_0x165c6d[a6_0x4cad('0x5b')],'executionId:\x20'+_0x165c6d[a6_0x4cad('0x0')],a6_0x4cad('0x1e')+_0x165c6d[a6_0x4cad('0x4f')][a6_0x4cad('0x1a')],a6_0x4cad('0x50')+_0x165c6d[a6_0x4cad('0x2a')],'maxParallel:\x20'+_0x165c6d[a6_0x4cad('0x58')]]});}if(_0x165c6d[a6_0x4cad('0x2a')]){output[a6_0x4cad('0x17')]({'title':a6_0x4cad('0x47'),'bodyLines':['Error:',_0x165c6d[a6_0x4cad('0x2a')]]});process[a6_0x4cad('0x5c')](0x0);}if((_0x165c6d===null||_0x165c6d===void 0x0?void 0x0:_0x165c6d[a6_0x4cad('0x5b')])&&(_0x165c6d===null||_0x165c6d===void 0x0?void 0x0:_0x165c6d[a6_0x4cad('0x5b')])!==0x0&&!_0x14bd76&&new Date()[a6_0x4cad('0x41')]()-_0x490299['getTime']()>_0x165c6d[a6_0x4cad('0x5b')]){yield _0x4f75fd[a6_0x4cad('0x3c')]();continue;}if((_0x165c6d===null||_0x165c6d===void 0x0?void 0x0:_0x165c6d[a6_0x4cad('0x8')])!==undefined){if(_0x165c6d[a6_0x4cad('0x8')]===a6_0x4cad('0x2')||_0x165c6d[a6_0x4cad('0x8')]===a6_0x4cad('0x3e')){return;}}else if(_0x165c6d[a6_0x4cad('0x18')]){return;}_0x37e3da(_0x165c6d[a6_0x4cad('0x4f')]['map'](_0x4e80ba=>_0x4e80ba['taskId'])[a6_0x4cad('0x46')](''));if(!_0x165c6d[a6_0x4cad('0x0')]){if(environment_1[a6_0x4cad('0x43')]){output['note']({'title':a6_0x4cad('0x4d')});}yield _0x4f75fd[a6_0x4cad('0x3c')]();_0x1818ad=0x0;_0x3d24d3=[];continue;}_0x4f75fd[a6_0x4cad('0x5')]();_0x14bd76=!![];const _0x4fbef3=invokeTasksUsingRunMany(_0x5ba313,_0x165c6d[a6_0x4cad('0x0')],_0x165c6d[a6_0x4cad('0x4f')],_0x165c6d['maxParallel']);_0x1818ad=_0x4fbef3[a6_0x4cad('0x28')];_0x3d24d3=_0x4fbef3[a6_0x4cad('0x2e')];}});}function readCompletedTasks(_0x4acbbb,_0x2e6466){const _0x142e9d=a6_0x4cad('0x38')+_0x2e6466+').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.';let _0x1f8fb7;try{const _0x164156=_0x4acbbb['cacheDirectory']||a6_0x4cad('0x35');const _0x29cd73=_0x164156+'/tasks-hashes-'+_0x2e6466;_0x1f8fb7=JSON['parse']((0x0,fs_1[a6_0x4cad('0xc')])(_0x29cd73)['toString']());(0x0,fs_1[a6_0x4cad('0x24')])(_0x29cd73);}catch(_0xa353db){throw new Error(_0x142e9d);}if(_0x1f8fb7[a6_0x4cad('0x1a')]==0x0){throw new Error(_0x142e9d);}return _0x1f8fb7;}function invokeTasksUsingRunMany(_0xd6e56,_0x3be776,_0x3158f6,_0x4ff280){let _0x11bc34=0x0;const _0x4965b5=[];for(const _0x3b1316 of groupByTarget(_0x3158f6)){const _0x58bc60=_0x3b1316[a6_0x4cad('0x4b')]?a6_0x4cad('0x25')+_0x3b1316[a6_0x4cad('0x4b')]:'';const _0x2aa467=_0x4ff280>0x1?a6_0x4cad('0x52')+_0x4ff280:'';const _0x3bf9b9='npx\x20nx\x20run-many\x20--target='+_0x3b1316['target']+'\x20'+_0x58bc60+'\x20--projects='+_0x3b1316[a6_0x4cad('0xe')][a6_0x4cad('0x46')](',')+'\x20'+_0x3b1316[a6_0x4cad('0x48')]+_0x2aa467;if(environment_1[a6_0x4cad('0x43')]){output['note']({'title':a6_0x4cad('0x1d')+_0x3bf9b9+'\x27'});}try{(0x0,child_process_1[a6_0x4cad('0x2f')])(_0x3bf9b9,{'stdio':['inherit',a6_0x4cad('0x1f'),a6_0x4cad('0x1f')],'env':Object['assign'](Object['assign']({},process['env']),{'NX_CACHE_FAILURES':'true','NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x3be776})});_0x4965b5[a6_0x4cad('0xb')](...readCompletedTasks(_0xd6e56,_0x3be776));}catch(_0x59e0af){if(_0x59e0af[a6_0x4cad('0x8')]===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x59e0af;}else{_0x11bc34=0x1;_0x4965b5[a6_0x4cad('0xb')](...readCompletedTasks(_0xd6e56,_0x3be776));}}}return{'completedStatusCode':_0x11bc34,'completedTasks':_0x4965b5};}function groupByTarget(_0x44a654){const _0x4e607b=[];_0x44a654[a6_0x4cad('0x49')](_0x582113=>{const _0x44e753=_0x4e607b[a6_0x4cad('0x3d')](_0x3e31e5=>_0x3e31e5[a6_0x4cad('0x9')]===_0x582113[a6_0x4cad('0x9')]&&_0x3e31e5[a6_0x4cad('0x4b')]===_0x582113[a6_0x4cad('0x4b')]);if(_0x44e753){_0x44e753['projects'][a6_0x4cad('0xb')](_0x582113[a6_0x4cad('0x32')]);}else{_0x4e607b[a6_0x4cad('0xb')]({'target':_0x582113['target'],'projects':[_0x582113[a6_0x4cad('0x32')]],'params':_0x582113[a6_0x4cad('0x48')],'configuration':_0x582113[a6_0x4cad('0x4b')]});}});return _0x4e607b;}function getAgentName(){if(process[a6_0x4cad('0x37')][a6_0x4cad('0x2d')]!==undefined){return process[a6_0x4cad('0x37')][a6_0x4cad('0x2d')];}else if(process['env'][a6_0x4cad('0x11')]!==undefined&&process['env'][a6_0x4cad('0x6')]){return process[a6_0x4cad('0x37')]['CIRCLE_STAGE'];}else if(process[a6_0x4cad('0x37')][a6_0x4cad('0x11')]!==undefined&&process[a6_0x4cad('0x37')][a6_0x4cad('0x40')]){return process[a6_0x4cad('0x37')][a6_0x4cad('0x40')];}else{return'Agent\x20'+Math[a6_0x4cad('0x1')](Math['random']()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x36f77b,_0x212cc1,_0x1fab4c){const _0x43c086=_0x212cc1[a6_0x4cad('0x22')]||'./node_modules/.cache/nx';const _0x3f069f=_0x43c086+a6_0x4cad('0x53');const _0x2591e5=_0x3f069f+'/'+_0x1fab4c+a6_0x4cad('0x4a');if(!(0x0,fs_1[a6_0x4cad('0x23')])(_0x3f069f)){(0x0,fs_1[a6_0x4cad('0x34')])(_0x3f069f,{'recursive':!![]});}const _0x4ff27a=(0x0,fs_1['readdirSync'])(_0x3f069f);if(_0x4ff27a['length']){if(_0x4ff27a[a6_0x4cad('0x59')](_0x1fab4c+a6_0x4cad('0x4a'))){output[a6_0x4cad('0x17')]({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':[a6_0x4cad('0x57'),'',a6_0x4cad('0x4')]});process['exit'](0x1);}output['warn']({'title':a6_0x4cad('0xf'),'bodyLines':['We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','',a6_0x4cad('0xd'),'If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.']});}(0x0,fs_1[a6_0x4cad('0x13')])(_0x2591e5,'');process['on'](a6_0x4cad('0x5c'),_0x45405f=>{cleanupAgentLockfile(_0x2591e5,_0x45405f);});process['on'](a6_0x4cad('0x36'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x36f77b[a6_0x4cad('0x44')](a6_0x4cad('0x4e'));cleanupAgentLockfile(_0x2591e5,0x1);}));process['on'](a6_0x4cad('0x16'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x36f77b[a6_0x4cad('0x44')](a6_0x4cad('0x31'));cleanupAgentLockfile(_0x2591e5,0x1);}));}function cleanupAgentLockfile(_0x5b999c,_0x55e48c){if((0x0,fs_1[a6_0x4cad('0x23')])(_0x5b999c)){(0x0,fs_1['unlinkSync'])(_0x5b999c);process[a6_0x4cad('0x5c')](_0x55e48c);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x473c23=(0x0,environment_1['getRunGroup'])();if(!_0x473c23){(0x0,print_run_group_error_1[a6_0x4cad('0x2b')])();return process['exit'](0x1);}output[a6_0x4cad('0x19')]({'title':'Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks'});const _0xdb640=JSON[a6_0x4cad('0x20')](stripJsonComments((0x0,fs_1['readFileSync'])(workspaceRoot+a6_0x4cad('0x10'))[a6_0x4cad('0x3b')]()))['tasksRunnerOptions'][a6_0x4cad('0x2c')]['options'];const _0x1deee2=getAgentName();const _0x392a93=new distributed_agent_api_1['DistributedAgentApi'](_0xdb640,_0x473c23,_0x1deee2);createAgentLockfileAndSetUpListeners(_0x392a93,_0xdb640,_0x1deee2);return executeTasks(_0xdb640,_0x392a93)[a6_0x4cad('0x39')](_0x3e2f7c=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x4cad('0x1c')])(_0xdb640);return _0x3e2f7c;}))[a6_0x4cad('0x1b')](_0x5b1582=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x392a93[a6_0x4cad('0x44')]('Critical\x20Error\x20in\x20Agent:\x20\x22'+_0x5b1582[a6_0x4cad('0x56')]+'\x22');throw _0x5b1582;}));});}exports[a6_0x4cad('0x5a')]=startAgent;