"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.migrateFromAngularCli = void 0;
const tslib_1 = require("tslib");
const devkit_1 = require("@nrwl/devkit");
const versions_1 = require("../../utils/versions");
const app_migrator_1 = require("./utilities/app.migrator");
const get_all_projects_1 = require("./utilities/get-all-projects");
const lib_migrator_1 = require("./utilities/lib.migrator");
const normalize_options_1 = require("./utilities/normalize-options");
const validate_projects_1 = require("./utilities/validate-projects");
const workspace_1 = require("./utilities/workspace");
function migrateFromAngularCli(tree, rawOptions) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        (0, workspace_1.validateWorkspace)(tree);
        const projects = (0, get_all_projects_1.getAllProjects)(tree);
        const options = (0, normalize_options_1.normalizeOptions)(tree, rawOptions, projects);
        if (options.preserveAngularCliLayout) {
            (0, devkit_1.addDependenciesToPackageJson)(tree, {}, {
                nx: versions_1.nxVersion,
                '@nrwl/workspace': versions_1.nxVersion,
            });
            (0, workspace_1.createNxJson)(tree, options, true);
            (0, workspace_1.decorateAngularCli)(tree);
        }
        else {
            const migrators = [
                ...projects.apps.map((app) => new app_migrator_1.AppMigrator(tree, options, app)),
                ...projects.libs.map((lib) => new lib_migrator_1.LibMigrator(tree, options, lib)),
            ];
            // validate all projects
            (0, validate_projects_1.validateProjects)(migrators);
            const workspaceCapabilities = (0, workspace_1.getWorkspaceCapabilities)(tree, projects);
            /**
             * Keep a copy of the root eslint config to restore it later. We need to
             * do this because the root config can also be the config for the app at
             * the root of the Angular CLI workspace and it will be moved as part of
             * the app migration.
             */
            let eslintConfig = workspaceCapabilities.eslint && tree.exists('.eslintrc.json')
                ? (0, devkit_1.readJson)(tree, '.eslintrc.json')
                : undefined;
            // create and update root files and configurations
            (0, devkit_1.updateJson)(tree, 'angular.json', (json) => (Object.assign(Object.assign({}, json), { version: 2, $schema: undefined })));
            (0, workspace_1.createNxJson)(tree, options);
            (0, workspace_1.updateWorkspaceConfigDefaults)(tree);
            (0, workspace_1.updateRootTsConfig)(tree);
            (0, workspace_1.updatePackageJson)(tree);
            (0, workspace_1.decorateAngularCli)(tree);
            yield (0, workspace_1.createWorkspaceFiles)(tree);
            // migrate all projects
            for (const migrator of migrators) {
                yield migrator.migrate();
            }
            /**
             * This needs to be done last because the Angular CLI workspace can have
             * these files in the root for the root application, so we wait until
             * those root config files are moved when the projects are migrated.
             */
            if (workspaceCapabilities.karma) {
                (0, workspace_1.createRootKarmaConfig)(tree);
            }
            if (workspaceCapabilities.eslint) {
                (0, workspace_1.updateRootEsLintConfig)(tree, eslintConfig, options.unitTestRunner);
                (0, workspace_1.cleanupEsLintPackages)(tree);
            }
            yield (0, devkit_1.formatFiles)(tree);
        }
        if (!options.skipInstall) {
            return () => {
                (0, devkit_1.installPackagesTask)(tree);
            };
        }
    });
}
exports.migrateFromAngularCli = migrateFromAngularCli;
//# sourceMappingURL=migrate-from-angular-cli.js.map